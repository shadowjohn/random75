<!doctype html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8">
    <script language="javascript" src="jquery.min.js"></script>
    <script language="javascript" src="jquery-migrate-3.4.0.min.js"></script>
    <script language="javascript" src="php.js"></script>
    <script src="jquery-ui-1.8.24/ui/minified/jquery-ui.min.js" type="text/javascript"></script>
    <link href="jquery-ui-1.8.24/themes/base/jquery.ui.all.css" rel="stylesheet" type="text/css">
    <script language="javascript" src="mybox.js"></script>
    <script language="javascript" src="include.js"></script>
    <title>2022年福委室長抽籤活動</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
            padding: 0px;
            margin: 0px;
            font-size: 2.5em;
            font-family: "微軟正黑體";
        }

        * {
            font-size: 1em;
            font-family: "微軟正黑體";
        }

        #step2 {
            font-size: 0.5em;
        }

        .focus {
            border: 2px solid #00b;
            font-weight: bold;
            color: blue;
        }

        /* 抽獎時，隨時跳的樣式 */
        .focusRandom {
            border: 2px solid #00b;
            font-weight: bold;
            color: #0026ff;
            background-color: #eef;
        }


        .memberTextareaClass {
            font-size: 0.7em;
            overflow: visible;
            min-height: 600px;
        }

        .randomDivs {
            float: left;
            margin-right: 20px;
            border: 1px solid #000;
            font-size: 1.2em;
            padding: 8px 4px 8px 4px;
        }

        .winNameClass {
            background-color: #fff;
            font-size: 3.5em;
            transform: rotate(6deg);
            font-weight: bold;
            border: 2px solid orange;
            padding: 28px 16px 28px 16px;
        }
    </style>
</head>
<body>
    <div align="right"><input type="button" value="Reload" onclick="location.reload();" style="font-size:12px;" /></div>
    <div id="step1">
        步驟一：請開啟名單 <input type="button" id="inputBtn" value="請選檔案" /><input type="file" id="input" style="display:none;" />
    </div>
    <div id="step2" style="display:none;"></div>
    <div id="step3" style="display:none;"></div>
</body>
<script>
    $("#inputBtn").unbind("click").click(function () {
        $("#input").trigger("click");
    });
    // From : https://www.npmjs.com/package/read-excel-file
    var readSheetNames = require('read-excel-file');
    var input = document.getElementById('input');
    window['gData'] = {};
    input.addEventListener('change', function () {
        for (var i = 2; i <= 5; i++) {
            (function (_i) {
                readSheetNames(input.files[0], { sheet: _i }).then((data) => {
                    //console.log(data);
                    //alert(print_r(data, true));
                    window['gData'][(_i - 1).toString()] = data;
                });
            })(i);
        }
        readSheetNames(input.files[0], { getSheets: true }).then((sheetNames) => {
            // sheetNames === ['Sheet1', 'Sheet2']
            console.log(sheetNames);
            //alert(print_r(sheetNames, true));
            $("#step1").hide();
            var html = new Array();
            for (var i = 1; i < sheetNames.length; i++) {
                var d = "<input type=\"button\" reqc=\"sheetNames\" req_id=\"" + i + "\" orin_value=\"抽" + sheetNames[i].name + "\" value=\"抽" + sheetNames[i].name + "\">";
                html.push(d);
            }
            $("#step2").show();
            $("#step2").html("<center>" + html.join("&nbsp;") + "</center><hr color='red'>");
            //按到 要抽哪一種
            $("input[reqc='sheetNames']").unbind("click").click(function () {
                $("input[reqc='sheetNames']").removeClass("focus");
                var kind_index = $(this).attr('req_id');
                $(this).addClass("focus");
                $("#step3").empty();
                var html = "";
                html += `
                <table style='width:100%;'>
                    <tr>
                        <td style='width:95%;'>
                            <p style='font-size:0.7em;line-height:0.7em;padding:10px;margin:0px;'>名單確認：</p>
                            <textarea id='memberTextarea' style='width:100%;' class='memberTextareaClass'>{members}</textarea>
                        </td>
                        <td valign="center">
                            <input type='button' id='runBtn' value='抽!!!'>
                        </td>
                    </tr>
                </table>`;

                //console.log(input.files[0]);
                //console.log(kind_index);
                console.log(window['gData'][kind_index]);
                var names = new Array();
                var step = 0;
                for (var i = 1, max_i = window['gData'][kind_index].length; i < max_i; i++) {
                    if (window['gData'][kind_index][i][1] == null) continue;
                    names.push(window['gData'][kind_index][i][1]);
                    if (step != 0 && step % 5 == 0) {
                        names[names.length - 1] = "\n" + names[names.length - 1];
                    }
                    step++;
                }
                html = html.replace("{members}", implode(",", names));
                $("#step3").html(html).fadeIn();


                // 按下抽
                // 名單從 textarea #memberTextarea 取得，移除所有 \n，用 , 分格，打亂 array，作抽獎效果
                $("#runBtn").unbind("click").click({ kind_index: kind_index }, function (e) {
                    clearInterval(window['runInterval']);
                    clearTimeout(window['time_down_func_' + window['tButtonInterval'] + '_timeout']);
                    window['lastKindIndex'] = e.data.kind_index;
                    var membersArr = $("#memberTextarea").val().replace("\n", "").split(",");
                    membersArr = shuffle(membersArr); //打亂
                    var m = new Array();
                    for (var i = 0, max_i = membersArr.length; i < max_i; i++) {
                        var d = "<div class='randomDivs'>" + membersArr[i] + "</div>";
                        m.push(d);
                    }
                    var html = implode("", m);
                    html += "<input type='button' style='position:absolute;right:30px;bottom:30px;' id='timedownBtn'>";
                    dialogMyBoxOn(html, true, function () {
                        //加個 min width、min height
                        $("div[id^='mybox_div']").css({
                            'min-width': '400px',
                            'min-height': '400px'
                        });
                        window['runInterval'] = setInterval(function () {
                            // 隨機人名框選開始作動
                            $(".randomDivs").removeClass("focusRandom");
                            $(".randomDivs").eq(rand(0, $(".randomDivs").length - 1)).addClass("focusRandom");
                        }, 30);

                        //timedownbutton(button_dom, title, seconds, done_func) {
                        //倒數計時關閉按鈕
                        window['tButtonInterval'] = timedownbutton("#timedownBtn", "倒數中", 8, function () {
                            //時間到
                            clearInterval(window['runInterval']);
                            setTimeout(function () {
                                //把贏的抓出來，全螢幕
                                window['winName'] = $(".focusRandom").text();
                                var html = "<div class='winNameClass'>" + window['winName'] + "</div>";
                                dialogMyBoxOn(html, true, function () {
                                    // 光箱出現後
                                    $("div[id^='mybox_div']").css({
                                        'background-color': 'transparent',
                                        'padding': '60px',
                                        'border': '0px'
                                    });
                                    setTimeout(function () {
                                        //把中獎名寫回
                                        var orin_value = $("input[reqc='sheetNames'][req_id='" + window['lastKindIndex'] + "']").attr('orin_value');
                                        $("input[reqc='sheetNames'][req_id='" + window['lastKindIndex'] + "']").val(orin_value + "(" + window['winName'] + ")");
                                        dialogMyBoxOff();
                                    }, 5000);
                                });
                            }, 500);
                        });
                    }, function () {
                        //如果臨時點旁邊關掉光箱    
                        clearTimeout(window['time_down_func_' + window['tButtonInterval'] + '_timeout']);
                        clearInterval(window['runInterval']);
                    });
                });


            });
        })
    });
</script>
</html>